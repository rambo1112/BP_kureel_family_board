<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INCOIS - Integrated Ocean Hazard Intelligence Platform</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet.js for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 */
            color: #e2e8f0; /* slate-200 */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Custom scrollbar for a better dark mode experience */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        
        /* Leaflet map custom theme */
        .leaflet-container {
            background: #1e293b; /* slate-800 */
        }
        .leaflet-tile-pane {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background-color: #1e293b;
            color: #e2e8f0;
            border: 1px solid #334155;
        }
        
        /* Custom component styles */
        .dashboard-card {
            background-color: #1e293b; /* slate-800 */
            border: 1px solid #334155; /* slate-700 */
            border-radius: 0.75rem;
        }
        .live-feed-item:hover {
            background-color: #334155; /* slate-700 */
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }
        .filter-btn {
            background-color: #334155;
            transition: background-color 0.2s;
        }
        .filter-btn:hover, .filter-btn.active {
            background-color: #4f46e5; /* indigo-600 */
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 flex-shrink-0 dashboard-card m-2 p-4 flex flex-col">
        <div class="flex items-center gap-3 mb-6">
            <i class="ph-bold ph-waves text-3xl text-indigo-400"></i>
            <div>
                <h1 class="font-bold text-lg text-white">INCOIS</h1>
                <p class="text-xs text-slate-400 -mt-1">Ocean Intelligence</p>
            </div>
        </div>
        <nav class="flex-grow space-y-2">
            <a href="#" class="flex items-center gap-3 px-3 py-2 bg-indigo-600 rounded-lg text-white">
                <i class="ph-bold ph-gauge"></i><span>Dashboard</span>
            </a>
            <a href="#" class="flex items-center gap-3 px-3 py-2 hover:bg-slate-700 rounded-lg">
                <i class="ph-bold ph-chart-bar"></i><span>Analytics</span>
            </a>
            <a href="#" class="flex items-center gap-3 px-3 py-2 hover:bg-slate-700 rounded-lg">
                <i class="ph-bold ph-users"></i><span>Citizen Reporters</span>
            </a>
            <a href="#" class="flex items-center gap-3 px-3 py-2 hover:bg-slate-700 rounded-lg">
                <i class="ph-bold ph-shield-warning"></i><span>Misinformation</span>
            </a>
            <a href="#" class="flex items-center gap-3 px-3 py-2 hover:bg-slate-700 rounded-lg">
                <i class="ph-bold ph-gear"></i><span>Settings</span>
            </a>
        </nav>
        <div class="mt-auto">
            <div class="p-3 bg-slate-900 rounded-lg">
                <p class="font-semibold text-sm text-white">Role-Based Access</p>
                <select id="roleSelector" class="w-full mt-2 bg-slate-700 border border-slate-600 rounded-md text-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="analyst">Analyst</option>
                    <option value="decision_maker">Decision Maker</option>
                    <option value="admin">Administrator</option>
                </select>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col gap-2 p-2 pr-0 overflow-y-auto">
        <!-- Header -->
        <header class="h-16 flex-shrink-0 flex items-center justify-between dashboard-card px-6">
            <h2 class="text-xl font-bold text-white">Common Operational Picture</h2>
            <div class="flex items-center gap-4">
                <div class="relative">
                    <i class="ph ph-magnifying-glass absolute top-1/2 left-3 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" placeholder="Search reports, locations..." class="bg-slate-900 border border-slate-700 rounded-lg w-72 pl-10 pr-4 py-2 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button class="relative p-2 rounded-full hover:bg-slate-700">
                    <i class="ph ph-bell text-xl"></i>
                    <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                </button>
                <div class="flex items-center gap-3">
                    <img src="https://placehold.co/40x40/4f46e5/ffffff?text=A" alt="Analyst Avatar" class="w-10 h-10 rounded-full border-2 border-slate-600">
                    <div>
                        <p class="font-semibold text-sm text-white">Dr. A. Kumar</p>
                        <p id="roleDisplay" class="text-xs text-slate-400">Analyst</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Grid -->
        <div class="flex-1 grid grid-cols-3 grid-rows-3 gap-2">
            <!-- Map -->
            <div class="col-span-2 row-span-3 dashboard-card" id="map"></div>

            <!-- KPIs -->
            <div class="dashboard-card p-4">
                <h3 class="font-semibold text-white mb-2">Key Metrics</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-900 p-3 rounded-lg">
                        <p class="text-xs text-slate-400">Total Reports (24h)</p>
                        <p class="text-2xl font-bold text-white" id="kpi-total">0</p>
                    </div>
                    <div class="bg-slate-900 p-3 rounded-lg">
                        <p class="text-xs text-slate-400">Unverified</p>
                        <p class="text-2xl font-bold text-yellow-400" id="kpi-unverified">0</p>
                    </div>
                    <div class="bg-slate-900 p-3 rounded-lg">
                        <p class="text-xs text-red-400">High Severity</p>
                        <p class="text-2xl font-bold text-red-500" id="kpi-high-severity">0</p>
                    </div>
                    <div class="bg-slate-900 p-3 rounded-lg">
                        <p class="text-xs text-green-400">Verified Incidents</p>
                        <p class="text-2xl font-bold text-green-500" id="kpi-verified">0</p>
                    </div>
                </div>
            </div>

            <!-- Reports by Hazard -->
            <div class="dashboard-card p-4 flex flex-col">
                <h3 class="font-semibold text-white mb-2">Reports by Hazard Type</h3>
                <div class="flex-grow min-h-0"><canvas id="hazardChart"></canvas></div>
            </div>

            <!-- Report Timeline -->
            <div class="dashboard-card p-4 flex flex-col">
                <h3 class="font-semibold text-white mb-2">Report Timeline (Last Hour)</h3>
                <div class="flex-grow min-h-0"><canvas id="timelineChart"></canvas></div>
            </div>
        </div>
    </main>

    <!-- Right Sidebar -->
    <aside class="w-96 flex-shrink-0 flex flex-col m-2 ml-0 gap-2">
        <!-- Filters -->
        <div class="dashboard-card p-4">
            <h3 class="font-semibold text-white mb-3">Filters</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs font-medium text-slate-400">Verification Status</label>
                    <div id="filter-verification" class="flex flex-wrap gap-2 mt-1">
                        <button data-filter="all" class="filter-btn active text-xs px-3 py-1 rounded-full">All</button>
                        <button data-filter="verified" class="filter-btn text-xs px-3 py-1 rounded-full">Verified</button>
                        <button data-filter="unverified" class="filter-btn text-xs px-3 py-1 rounded-full">Unverified</button>
                        <button data-filter="debunked" class="filter-btn text-xs px-3 py-1 rounded-full">Debunked</button>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-medium text-slate-400">Data Source</label>
                    <div id="filter-source" class="flex flex-wrap gap-2 mt-1">
                        <button data-filter="all" class="filter-btn active text-xs px-3 py-1 rounded-full">All</button>
                        <button data-filter="app" class="filter-btn text-xs px-3 py-1 rounded-full">Citizen App</button>
                        <button data-filter="social" class="filter-btn text-xs px-3 py-1 rounded-full">Social Media</button>
                    </div>
                </div>
                <div>
                    <label for="date-filter" class="text-xs font-medium text-slate-400">Date Range</label>
                    <input type="date" id="date-filter" class="w-full mt-1 bg-slate-700 border border-slate-600 rounded-md text-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
        </div>
        <!-- Live Feed -->
        <div class="dashboard-card p-4 flex-grow flex flex-col overflow-hidden">
            <h3 class="font-semibold text-white mb-2">Live Incident Feed</h3>
            <div id="live-feed" class="flex-grow overflow-y-auto pr-2 space-y-2">
                <!-- Feed items will be injected here -->
            </div>
        </div>
    </aside>

    <!-- Modal for Report Details -->
    <div id="report-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="dashboard-card w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-slate-700">
                <h2 id="modal-title" class="text-lg font-bold text-white">Report Details</h2>
                <button onclick="closeModal()" class="p-1 rounded-full hover:bg-slate-700">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4">
                <div class="grid grid-cols-3 gap-4 text-sm">
                    <div><strong class="text-slate-400 block">Hazard Type</strong><span id="modal-hazard"></span></div>
                    <div><strong class="text-slate-400 block">Status</strong><span id="modal-status"></span></div>
                    <div><strong class="text-slate-400 block">Source</strong><span id="modal-source"></span></div>
                    <div><strong class="text-slate-400 block">Timestamp</strong><span id="modal-timestamp"></span></div>
                    <div class="col-span-2"><strong class="text-slate-400 block">Location</strong><span id="modal-location"></span></div>
                </div>
                <div>
                    <strong class="text-slate-400 block mb-1">Description</strong>
                    <p id="modal-description" class="text-sm bg-slate-900 p-3 rounded-lg"></p>
                </div>
                <div id="modal-image-container">
                    <strong class="text-slate-400 block mb-1">Attached Media</strong>
                    <img id="modal-image" src="" alt="Report media" class="rounded-lg w-full max-h-64 object-cover">
                </div>
                <div id="modal-social-container" class="hidden">
                    <strong class="text-slate-400 block mb-1">Social Media Post</strong>
                    <div class="bg-slate-900 p-3 rounded-lg">
                        <div class="flex items-center gap-2 mb-2">
                             <img id="modal-social-avatar" src="" class="w-8 h-8 rounded-full">
                             <div>
                                 <p id="modal-social-user" class="font-semibold text-sm"></p>
                                 <p class="text-xs text-slate-400">Sentiment: <span id="modal-sentiment"></span></p>
                             </div>
                        </div>
                        <p id="modal-social-text" class="text-sm"></p>
                    </div>
                </div>
            </div>
            <div id="modal-actions-analyst" class="p-4 mt-auto border-t border-slate-700 flex items-center justify-end gap-3">
                <button onclick="updateReportStatus('debunked')" class="px-4 py-2 text-sm font-semibold text-white bg-slate-600 hover:bg-slate-500 rounded-lg">Debunk</button>
                <button onclick="updateReportStatus('flagged')" class="px-4 py-2 text-sm font-semibold text-white bg-orange-600 hover:bg-orange-500 rounded-lg">Flag for Review</button>
                <button onclick="updateReportStatus('verified')" class="px-4 py-2 text-sm font-semibold text-white bg-green-600 hover:bg-green-500 rounded-lg">Verify Incident</button>
            </div>
        </div>
    </div>


    <script>
        // --- DATA SIMULATION ---
        const hazardTypes = {
            'coastal_flooding': { label: 'Coastal Flooding', icon: 'ðŸŒŠ', color: '#3b82f6' },
            'storm_surge': { label: 'Storm Surge', icon: 'ðŸŒ€', color: '#ef4444' },
            'high_waves': { label: 'High Waves', icon: 'æ³¢', color: '#22d3ee' },
            'maritime_incident': { label: 'Maritime Incident', icon: 'ðŸš¤', color: '#f97316' },
            'tsunami_alert': { label: 'Tsunami Alert', icon: 'ðŸš¨', color: '#f43f5e' }
        };

        const coastalLocations = [
            { name: "Puri, Odisha", coords: [19.813, 85.831] },
            { name: "Visakhapatnam, AP", coords: [17.686, 83.218] },
            { name: "Chennai, Tamil Nadu", coords: [13.082, 80.270] },
            { name: "Kochi, Kerala", coords: [9.931, 76.267] },
            { name: "Mumbai, Maharashtra", coords: [19.076, 72.877] },
            { name: "Goa", coords: [15.299, 74.124] },
            { name: "Digha, West Bengal", coords: [21.624, 87.524] },
            { name: "Kanyakumari, Tamil Nadu", coords: [8.088, 77.538] },
            { name: "Rameswaram, Tamil Nadu", coords: [9.287, 79.312] },
            { name: "Mangalore, Karnataka", coords: [12.914, 74.856] }
        ];

        const sampleDescriptions = [
            "Water level rising rapidly near the fish market.",
            "Strong waves are crashing over the sea wall.",
            "A fishing boat seems to be in trouble about 2km from the shore.",
            "Local authorities have issued an evacuation warning.",
            "The main coastal road is completely submerged.",
            "Hearing unconfirmed reports of a tsunami. Can anyone verify?",
            "The cyclone has made landfall, heavy winds and rain.",
        ];
        
        const socialUsers = [
            { name: 'Rahul S.', avatar: 'https://placehold.co/40x40/3498db/ffffff?text=RS' },
            { name: 'Priya G.', avatar: 'https://placehold.co/40x40/e74c3c/ffffff?text=PG' },
            { name: 'Amit K.', avatar: 'https://placehold.co/40x40/2ecc71/ffffff?text=AK' },
        ];

        let allReports = [];
        let currentFilters = {
            verification: 'all',
            source: 'all',
            date: null,
        };
        let currentVisibleReportId = null;

        function generateMockData(count = 100) {
            const now = new Date();
            for (let i = 0; i < count; i++) {
                const isAppReport = Math.random() > 0.4;
                const location = coastalLocations[Math.floor(Math.random() * coastalLocations.length)];
                const hazardKeys = Object.keys(hazardTypes);
                const hazard = hazardKeys[Math.floor(Math.random() * hazardKeys.length)];
                const statusOptions = ['unverified', 'verified', 'debunked', 'flagged'];
                const status = statusOptions[Math.floor(Math.random() * statusOptions.length)];
                const severityOptions = ['low', 'medium', 'high'];
                const severity = status === 'verified' ? severityOptions[Math.floor(Math.random() * severityOptions.length)] : 'low';
                
                const reportTime = new Date(now.getTime() - Math.random() * 24 * 60 * 60 * 1000);

                let report = {
                    id: `rep_${Date.now()}_${i}`,
                    timestamp: reportTime,
                    location: {
                        name: location.name,
                        lat: location.coords[0] + (Math.random() - 0.5) * 0.1,
                        lng: location.coords[1] + (Math.random() - 0.5) * 0.1,
                    },
                    hazard: hazard,
                    status: status,
                    severity: severity,
                    source: isAppReport ? 'app' : 'social',
                    description: sampleDescriptions[Math.floor(Math.random() * sampleDescriptions.length)],
                };

                if (isAppReport) {
                    report.media = `https://placehold.co/600x400/1e293b/ffffff?text=Hazard+Media`;
                } else {
                    const user = socialUsers[Math.floor(Math.random() * socialUsers.length)];
                    report.social = {
                        user: user.name,
                        avatar: user.avatar,
                        sentiment: ['negative', 'neutral', 'positive'][Math.floor(Math.random()*3)]
                    };
                }
                allReports.push(report);
            }
            allReports.sort((a, b) => b.timestamp - a.timestamp);
        }

        // --- MAP INITIALIZATION ---
        const map = L.map('map').setView([15.0, 78.0], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 19
        }).addTo(map);
        let markers = L.markerClusterGroup();

        function getMarkerIcon(report) {
            const iconHtml = `<div style="background-color:${hazardTypes[report.hazard].color};" class="w-6 h-6 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg">${hazardTypes[report.hazard].icon}</div>`;
            return L.divIcon({
                html: iconHtml,
                className: 'custom-div-icon',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
        }
        
        function getStatusBadge(status) {
             const statusStyles = {
                verified: 'bg-green-500/20 text-green-400 border-green-500/30',
                unverified: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
                debunked: 'bg-slate-500/20 text-slate-400 border-slate-500/30',
                flagged: 'bg-orange-500/20 text-orange-400 border-orange-500/30',
             };
             return `<span class="text-xs px-2 py-0.5 rounded-full border ${statusStyles[status] || ''}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>`;
        }


        // --- UI UPDATES ---
        function updateUI() {
            const filteredReports = getFilteredReports();
            updateMap(filteredReports);
            updateKPIs(filteredReports);
            updateCharts(filteredReports);
            updateLiveFeed(filteredReports);
        }
        
        function getFilteredReports() {
             return allReports.filter(r => {
                const verificationMatch = currentFilters.verification === 'all' || r.status === currentFilters.verification;
                const sourceMatch = currentFilters.source === 'all' || r.source === currentFilters.source;
                // Note: Date filter logic would be more complex, this is a placeholder
                return verificationMatch && sourceMatch;
            });
        }

        function updateMap(reports) {
            markers.clearLayers();
            reports.forEach(report => {
                const marker = L.marker([report.location.lat, report.location.lng], { icon: getMarkerIcon(report) });
                marker.bindPopup(`
                    <div class="w-64">
                        <strong class="text-base">${hazardTypes[report.hazard].label}</strong>
                        <p class="text-sm text-slate-300 mt-1">${report.description.substring(0, 50)}...</p>
                        <div class="mt-2 text-xs">${new Date(report.timestamp).toLocaleString()}</div>
                        <div class="mt-2">${getStatusBadge(report.status)}</div>
                        <button class="w-full mt-3 bg-indigo-600 text-white text-sm py-1 rounded-md hover:bg-indigo-500" onclick="openModal('${report.id}')">View Details</button>
                    </div>
                `);
                markers.addLayer(marker);
            });
            map.addLayer(markers);
        }

        function updateKPIs(reports) {
            const now = new Date();
            const last24h = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            const reports24h = reports.filter(r => new Date(r.timestamp) > last24h);
            
            document.getElementById('kpi-total').textContent = reports24h.length;
            document.getElementById('kpi-unverified').textContent = reports24h.filter(r => r.status === 'unverified').length;
            document.getElementById('kpi-high-severity').textContent = reports24h.filter(r => r.severity === 'high' && r.status === 'verified').length;
            document.getElementById('kpi-verified').textContent = reports24h.filter(r => r.status === 'verified').length;
        }
        
        function updateLiveFeed(reports) {
            const feedContainer = document.getElementById('live-feed');
            feedContainer.innerHTML = '';
            const latestReports = reports.slice(0, 50); // Show latest 50
            
            latestReports.forEach(report => {
                const timeAgo = Math.round((new Date() - new Date(report.timestamp)) / 1000 / 60);
                const item = document.createElement('div');
                item.className = 'p-3 rounded-lg cursor-pointer transition-colors live-feed-item';
                item.onclick = () => openModal(report.id);
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">${hazardTypes[report.hazard].icon}</span>
                            <div>
                                <p class="font-semibold text-sm text-white">${hazardTypes[report.hazard].label}</p>
                                <p class="text-xs text-slate-400">${report.location.name}</p>
                            </div>
                        </div>
                        <span class="text-xs text-slate-500">${timeAgo}m ago</span>
                    </div>
                    <p class="text-sm mt-1 pl-8 text-slate-300">${report.description.substring(0,80)}${report.description.length > 80 ? '...' : ''}</p>
                    <div class="pl-8 mt-2">${getStatusBadge(report.status)}</div>
                `;
                feedContainer.appendChild(item);
            });
        }
        
        // --- CHARTS ---
        let hazardChartInstance, timelineChartInstance;

        function setupCharts() {
            const hazardCtx = document.getElementById('hazardChart').getContext('2d');
            hazardChartInstance = new Chart(hazardCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [],
                        borderColor: '#1e293b',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#94a3b8',
                                boxWidth: 12,
                                padding: 10,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });

            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            timelineChartInstance = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Reports',
                        data: [],
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                           type: 'time',
                           time: { unit: 'minute' },
                           grid: { color: 'rgba(255,255,255,0.1)' },
                           ticks: { color: '#94a3b8', font: {size: 10} }
                        },
                        y: {
                           beginAtZero: true,
                           grid: { color: 'rgba(255,255,255,0.1)' },
                           ticks: { color: '#94a3b8', font: {size: 10}, stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function updateCharts(reports) {
            // Hazard Chart
            const hazardCounts = {};
            Object.keys(hazardTypes).forEach(key => hazardCounts[key] = 0);
            reports.forEach(r => hazardCounts[r.hazard]++);
            
            hazardChartInstance.data.labels = Object.values(hazardTypes).map(h => h.label);
            hazardChartInstance.data.datasets[0].data = Object.values(hazardCounts);
            hazardChartInstance.data.datasets[0].backgroundColor = Object.values(hazardTypes).map(h => h.color);
            hazardChartInstance.update();

            // Timeline Chart
            const now = new Date();
            const lastHour = new Date(now.getTime() - 60 * 60 * 1000);
            const reportsLastHour = reports.filter(r => new Date(r.timestamp) > lastHour);
            const timelineData = reportsLastHour.map(r => ({ x: r.timestamp, y: 1 }));
            
            // Aggregate data into 5-minute bins
            const binnedData = {};
            for(let i = 0; i < 12; i++) {
                const binTime = new Date(lastHour.getTime() + i * 5 * 60 * 1000);
                binnedData[binTime.toISOString()] = { x: binTime, y: 0 };
            }
            reportsLastHour.forEach(r => {
                const reportTime = new Date(r.timestamp);
                const binIndex = Math.floor((reportTime - lastHour) / (5 * 60 * 1000));
                const binTime = new Date(lastHour.getTime() + binIndex * 5 * 60 * 1000);
                if (binnedData[binTime.toISOString()]) {
                    binnedData[binTime.toISOString()].y += 1;
                }
            });

            timelineChartInstance.data.datasets[0].data = Object.values(binnedData);
            timelineChartInstance.options.scales.x.min = lastHour;
            timelineChartInstance.options.scales.x.max = now;
            timelineChartInstance.update();
        }

        // --- MODAL & ACTIONS ---
        const modal = document.getElementById('report-modal');

        function openModal(reportId) {
            currentVisibleReportId = reportId;
            const report = allReports.find(r => r.id === reportId);
            if (!report) return;

            document.getElementById('modal-title').textContent = `Report #${report.id.slice(-6)}`;
            document.getElementById('modal-hazard').textContent = hazardTypes[report.hazard].label;
            document.getElementById('modal-status').innerHTML = getStatusBadge(report.status);
            document.getElementById('modal-source').textContent = report.source === 'app' ? 'Citizen App' : 'Social Media';
            document.getElementById('modal-timestamp').textContent = new Date(report.timestamp).toLocaleString();
            document.getElementById('modal-location').textContent = `${report.location.name} (${report.location.lat.toFixed(4)}, ${report.location.lng.toFixed(4)})`;
            document.getElementById('modal-description').textContent = report.description;
            
            const imageContainer = document.getElementById('modal-image-container');
            const socialContainer = document.getElementById('modal-social-container');
            
            if(report.source === 'app' && report.media) {
                document.getElementById('modal-image').src = report.media;
                imageContainer.classList.remove('hidden');
                socialContainer.classList.add('hidden');
            } else if (report.source === 'social' && report.social) {
                document.getElementById('modal-social-avatar').src = report.social.avatar;
                document.getElementById('modal-social-user').textContent = report.social.user;
                document.getElementById('modal-sentiment').textContent = report.social.sentiment;
                document.getElementById('modal-social-text').textContent = report.description;
                imageContainer.classList.add('hidden');
                socialContainer.classList.remove('hidden');
            } else {
                 imageContainer.classList.add('hidden');
                 socialContainer.classList.add('hidden');
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentVisibleReportId = null;
        }

        function updateReportStatus(newStatus) {
            if(!currentVisibleReportId) return;
            const reportIndex = allReports.findIndex(r => r.id === currentVisibleReportId);
            if (reportIndex > -1) {
                allReports[reportIndex].status = newStatus;
                if(newStatus === 'verified') allReports[reportIndex].severity = 'high'; // Simulate severity change
                closeModal();
                updateUI();
            }
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            generateMockData(250);
            setupCharts();
            updateUI();

            // Simulate new data coming in
            setInterval(() => {
                const location = coastalLocations[Math.floor(Math.random() * coastalLocations.length)];
                const hazardKeys = Object.keys(hazardTypes);
                const hazard = hazardKeys[Math.floor(Math.random() * hazardKeys.length)];
                let newReport = {
                    id: `rep_new_${Date.now()}`,
                    timestamp: new Date(),
                    location: {
                        name: location.name,
                        lat: location.coords[0] + (Math.random() - 0.5) * 0.1,
                        lng: location.coords[1] + (Math.random() - 0.5) * 0.1,
                    },
                    hazard: hazard,
                    status: 'unverified',
                    severity: 'low',
                    source: 'app',
                    description: "New incoming report: " + sampleDescriptions[Math.floor(Math.random() * sampleDescriptions.length)],
                    media: `https://placehold.co/600x400/1e293b/ffffff?text=New+Report`
                };
                allReports.unshift(newReport);
                updateUI();
            }, 10000); // Every 10 seconds

            // Filter listeners
            document.querySelectorAll('#filter-verification button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentFilters.verification = e.target.dataset.filter;
                    document.querySelectorAll('#filter-verification button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    updateUI();
                });
            });
            document.querySelectorAll('#filter-source button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentFilters.source = e.target.dataset.filter;
                    document.querySelectorAll('#filter-source button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    updateUI();
                });
            });

            // Role selector
            const roleSelector = document.getElementById('roleSelector');
            const roleDisplay = document.getElementById('roleDisplay');
            const analystActions = document.getElementById('modal-actions-analyst');
            roleSelector.addEventListener('change', (e) => {
                const role = e.target.value;
                if (role === 'analyst') {
                    roleDisplay.textContent = 'Analyst';
                    analystActions.style.display = 'flex';
                } else if (role === 'decision_maker') {
                    roleDisplay.textContent = 'Decision Maker';
                    analystActions.style.display = 'none';
                } else {
                    roleDisplay.textContent = 'Administrator';
                    analystActions.style.display = 'none';
                }
            });
        });

    </script>
</body>
</html>
